{% extends 'base.html' %}
{% load tags %}
{% block content %}
        {% if not crew %}
        <div class="form-top col-md-12"></div>
        <div class="col-md-2"></div>
        <div class="col-md-8">
            <h2>Новая команда</h2>
            {% include 'helpdesk/form_new_crew.html' %}
        </div>
        <div class="col-md-2"></div>
        <div class="form-bottom col-md-12"></div>
        {% else %}
            {% chk_member_admin crew as is_admin  %}
            {% chk_member_dispatcher crew as is_dispatcher  %}
            <div class="col-md-12">
                <h2>Команда &laquo{{ crew.name }}&raquo;</h2>
            </div>
            {% if is_admin %}
            <div class="col-md-6">
                <h2>Свойства команды</h2>
                {% include 'helpdesk/form_edit_crew.html' %}
            </div>
            <div class="col-md-6">
                <h2>Услуги</h2>
                <div id="crew-service-list"></div>
                <div class="float-form" id="crew-service-price-list"></div>
                <script>
                    function loadServiceList() {
                        var tmpl = "<div class=\"crew-service-list\">\n" +
                            "   [[name]]\n" +
                            "   <div class=\"btn-group\" role=\"group\">\n" +
                            "       <a href=\"#\" class=\"btn btn-link btn-xs dropdown-toggle\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">\n" +
                            "           <i class=\"fa fa-cog color-dg\" aria-hidden=\"true\"></i>\n" +
                            "       </a>\n" +
                            "       <ul class=\"dropdown-menu dropdown-menu-right\">\n" +
                            "           <li>\n" +
                            "               <a data-fancybox data-options='{\"src\": \"#hidden-form-serviceedit\", \"modal\": true}' href=\"javascript:;\">\n" +
                            "                  <i class=\"fa fa-pencil\" aria-hidden=\"true\"></i> Изменить\n" +
                            "               </a>\n" +
                            "           </li>\n" +
                            "           <li>\n" +
                            "               <a href=\"#\" onclick=\"getPrice('[[pk]]'); return false;\"><i class=\"fa fa-rub\" aria-hidden=\"true\"></i> Прайс</a>\n" +
                            "           </li>\n" +
                            "           <li role=\"separator\" class=\"divider\"></li>\n" +
                            "           <li>\n" +
                            "               <a href=\"#\"><i class=\"fa fa-times\" aria-hidden=\"true\"></i> Удалить</a>\n" +
                            "           </li>\n" +
                            "       </ul>\n" +
                            "   </div>\n" +
                            "</div>";
                        $.getJSON( "{% url 'api_service_list' %}{{ crew.slug }}/", function( data ) {
                            try {
                                if (data['message'] == '') {
                                    var html_data = '';
                                    data = JSON.parse(data['data']);
                                    $.each(data, function (key, val) {
                                        html_data += tmpl
                                            .replace('[[name]]', val['fields']['name'])
                                            .replace('[[pk]]', val['pk']);
                                    });
                                    $('#crew-service-list').html(html_data);
                                }
                            }
                            catch (err) {
                                console.error(err);
                            }
                        });
                    }

                    function getPrice(service) {
                        var tmpl = "" +
                            "<td>[[start_date]]</td>" +
                            "<td>[[cost]]</td>" +
                            "<td>[[prepay]]</td>" +
                            "<td>[[fine1]]</td>" +
                            "<td>[[fine2]]</td>" +
                            "<td>" +
                            "   <i class=\"fa fa-pencil\" aria-hidden=\"true\"></i>" +
                            "   <i class=\"fa fa-times\" aria-hidden=\"true\"></i>" +
                            "</td>";
                        $.getJSON( "{% url 'api_service_price_list' %}" + service + "/", function( data ) {
                            try {
                                if (data['message'] == '') {
                                    var html_data = '';
                                    data = JSON.parse(data['data']);
                                    $.each(data, function (key, val) {
                                        html_data += "<tr>" + tmpl
                                            .replace('[[start_date]]', val['fields']['start_date'])
                                            .replace('[[cost]]', val['fields']['cost'])
                                            .replace('[[prepay]]', val['fields']['prepay'])
                                            .replace('[[fine1]]', val['fields']['fine1'])
                                            .replace('[[fine2]]', val['fields']['fine2'])
                                            .replace('[[pk]]', val['pk']) + "</tr>";
                                    });
                                    $('#crew-service-price-list').html("" +
                                        "<div class=\"col-md-12\">" +
                                        "   <table class=\"data-table\">" +
                                        "      <thead><tr>" +
                                        "          <td>Дата начала действия</td>" +
                                        "          <td>Цена</td>" +
                                        "          <td>Преодплата</td>" +
                                        "          <td>Штраф за невыполнение заявки в срок</td>" +
                                        "          <td>Штраф за просроченную заявку</td>" +
                                        "          <td></td>" +
                                        "      </tr></thead>" +
                                        "      " + html_data + "" +
                                        "   </table></div>" +
                                        "<div class=\"col-md-12\">" +
                                        "   <div class=\"col-md-6\"><input type=\"submit\" class=\"form-control btn btn-primary\" value=\"добавить\" /></div>\n" +
                                        "   <div class=\"col-md-6\"><button data-fancybox-close class=\"form-control btn btn-default\">отмена</button></div>\n" +
                                        "</div>\n");
                                    $.fancybox.open({
                                        src: '#crew-service-price-list',
                                        type: 'inline',
                                        opts: {modal: true}
                                    });
                                }
                            }
                            catch (err) {
                                console.error(err);
                            }
                        });
                    }

                    function init() {
                        loadServiceList();
                    }
                </script>
                <a data-fancybox data-options='{"src": "#hidden-form-serviceedit", "modal": true}' href="javascript:;" class="form-control btn btn-primary">Добавить услугу</a>

                <div class="float-form" style="display: none;" id="hidden-form-serviceedit">
                    {% include 'helpdesk/form_edit_service.html' %}
                </div>


            </div>
            <div class="col-md-6 crew-edit">
                <h2>Члены команды</h2>
                {% for cu in crew.crewusers_set.all %}
                <div class="crew-user-list">
                    {% ifequal cu.type 0 %}<i class="fa fa-user color-b" aria-hidden="true" title="Администратор"></i> {% endifequal %}
                    {% ifequal cu.type 1 %}<i class="fa fa-user color-o" aria-hidden="true" title="Диспетчер"></i> {% endifequal %}
                    {% ifequal cu.type 2 %}<i class="fa fa-user color-y" aria-hidden="true" title="Оператор"></i> {% endifequal %}
                    {{ cu.user.name }}
                    <div class="btn-group" role="group">
                        <a href="#" class="btn btn-link btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fa fa-cog color-dg" aria-hidden="true"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li><a href="{% url 'crew_edit_user_edit' crew.url cu.user.email 'a' %}">
                                {% ifequal cu.type 0 %}
                                    <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                {% else %}
                                    <i class="fa fa-square-o" aria-hidden="true"></i>
                                {% endifequal %}
                                Администратор</a></li>
                            <li><a href="{% url 'crew_edit_user_edit' crew.url cu.user.email 'd' %}">
                                {% ifequal cu.type 1 %}
                                    <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                {% else %}
                                    <i class="fa fa-square-o" aria-hidden="true"></i>
                                {% endifequal %}
                                Диспетчер</a></li>
                            <li><a href="{% url 'crew_edit_user_edit' crew.url cu.user.email 'o' %}">
                                {% ifequal cu.type 2 %}
                                    <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                {% else %}
                                    <i class="fa fa-square-o" aria-hidden="true"></i>
                                {% endifequal %}
                                Оператор</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="#"><i class="fa fa-times" aria-hidden="true"></i> Удалить</a></li>
                        </ul>
                    </div>
                </div>
                {% endfor %}
                <div class="col-md-12">
                    <input type="submit" class="form-control btn btn-primary" value="пригласить нового участника" />
                </div>
            </div>
            {% endif %}
            <div class="col-md-6">
                <h2>Персональные настройки</h2>
                <form action="{% url 'crew_edit' %}" method="post" id="form-crewedit" enctype="multipart/form-data">
                </form>
            </div>
        {% endif %}
{% endblock %}
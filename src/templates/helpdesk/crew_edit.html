{% extends 'base.html' %}
{% load tags %}
{% block content %}
        {% if not crew %}
        <div class="form-top col-md-12"></div>
        <div class="col-md-2"></div>
        <div class="col-md-8">
            {% ifequal action 'new' %}
            <h2>Новая команда</h2>
                {% include 'helpdesk/form_add_crew.html' %}
            {% else %}
                {% include 'helpdesk/form_new_crew.html' %}
            {% endifequal %}
        </div>
        <div class="col-md-2"></div>
        <div class="form-bottom col-md-12"></div>
        {% else %}
            {% chk_member_admin crew as is_admin  %}
            {% chk_member_dispatcher crew as is_dispatcher  %}
            <div class="col-md-12 crew-title">
                <span><a href="{% url 'crew_view' crew.url %}"><i class="fa fa-arrow-left color-b" aria-hidden="true"></i></a>
                    Настройка команды &laquo{{ crew.name }}&raquo;</span>
            </div>
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#tab_personal" aria-controls="tab_personal" role="tab" data-toggle="tab">Персональные настройки</a></li>
                {% if is_admin %}
                <li role="presentation"><a href="#tab_crew" aria-controls="tab_crew" role="tab" data-toggle="tab">Свойства команды</a></li>
                <li role="presentation"><a href="#tab_service" aria-controls="tab_service" role="tab" data-toggle="tab">Услуги</a></li>
                <li role="presentation"><a href="#tab_priority" aria-controls="tab_priority" role="tab" data-toggle="tab">Приоритеты</a></li>
                <li role="presentation"><a href="#tab_table" aria-controls="tab_table" role="tab" data-toggle="tab">Справочники</a></li>
                <li role="presentation"><a href="#tab_users" aria-controls="tab_users" role="tab" data-toggle="tab">Члены команды</a></li>
                <li role="presentation"><a href="#tab_events" aria-controls="tab_events" role="tab" data-toggle="tab">События</a></li>
                {% endif %}
            </ul>
            <div class="tab-content">
                {% if is_admin %}
                <div role="tabpanel" class="tab-pane" id="tab_crew">
                    <div class="col-md-12">
                        <div id="crew-edit"></div>
                    </div>
                </div>
                    <div role="tabpanel" class="tab-pane" id="tab_table">
                        <div id="crew-table-list"></div>
                        <div class="float-form" style="display: none;" id="hidden-crew-table-edit"></div>
                        <div class="float-form" style="display: none;" id="hidden-table-row-list"></div>
                        <div class="float-form" style="display: none;" id="hidden-table-row-edit"></div>
                        <div class="col-md-6">
                            <a href="#" class="form-control btn btn-primary" onclick="editTable('0'); return false;">Добавить справочник</a>
                        </div>

                    </div>
                    <div role="tabpanel" class="tab-pane" id="tab_service">
                        <div id="crew-service-list"></div>
                        <div class="float-form" style="display: none;" id="hidden-service-price-list"></div>
                        <div class="float-form" style="display: none;" id="hidden-crew-service-edit"></div>
                        <div class="float-form" style="display: none;" id="hidden-service-price-edit"></div>
                        <div class="col-md-6">
                            <a href="#" class="form-control btn btn-primary" onclick="editService('0'); return false;">Добавить услугу</a>
                        </div>

                    </div>
                <div role="tabpanel" class="tab-pane" id="tab_priority">
                    <div id="task-priority-list"></div>
                    <div class="float-form" style="display: none;" id="hidden-task-priority-edit"></div>
                    <div class="col-md-6">
                        <a href="#" class="form-control btn btn-primary" onclick="editPriority('0'); return false;">Добавить приоритет</a>
                    </div>

                </div>
                <div role="tabpanel" class="tab-pane" id="tab_events">
                    <div id="crew-events-list"></div>
                    <div class="col-md-6">
                        <a href="#" class="form-control btn btn-primary" onclick="loadEventsList(1000); return false;">Загрузить последние 1000 событий</a>
                    </div>

                </div>
                <div role="tabpanel" class="tab-pane" id="tab_users">
                    <div id="crew-user-list"></div>
                    <div class="float-form" style="display: none;" id="hidden-crew-user-add"></div>
                    <div class="col-md-3">
                        <input type="button" class="form-control btn btn-primary" value="пригласить нового участника" onclick="openInvite(); return false;" />
                    </div>
                    <div class="col-md-3">
                        <input type="button" class="form-control btn btn-primary" value="добавить нового участника" onclick="addExistUser(); return false;" />
                    </div>
                </div>
                {% endif %}
                <div role="tabpanel" class="tab-pane active" id="tab_personal">
                    <form action="{% url 'crew_edit' %}" method="post" id="form-crewedit" enctype="multipart/form-data">
                    </form>
                </div>
            </div>
        {% endif %}


        {% if is_admin %}
            {% include 'helpdesk/tmpl_crew_edit.html' %}
            {% include 'helpdesk/tmpl_service_list.html' %}
            {% include 'helpdesk/tmpl_service_edit.html' %}
            {% include 'helpdesk/tmpl_price_list.html' %}
            {% include 'helpdesk/tmpl_price_edit.html' %}
            {% include 'helpdesk/tmpl_user_list.html' %}
            {% include 'helpdesk/tmpl_user_invite.html' %}
            {% include 'helpdesk/tmpl_user_add.html' %}
            {% include 'helpdesk/tmpl_priority_list.html' %}
            {% include 'helpdesk/tmpl_priority_edit.html' %}
            {% include 'helpdesk/tmpl_events_list.html' %}
            {% include 'dyntable/tmpl_table_list.html' %}
            {% include 'dyntable/tmpl_table_edit.html' %}
            <script>
                function loadCrew() {
                    $.getJSON( "{% url 'api_crew_edit' %}{{ crew.slug }}/", function( data ) {
                        try {
                            if (data['message'] == '') {
                                var tmpl = $.templates("#tmpl-crew-edit");
                                var html = tmpl.render(data);
                                $('#crew-edit').html(html);
                                $.validate({
                                    form : '#form-crew-edit'
                                });
                                $('#datetimepicker-work-start-time').datetimepicker({
                                    format: 'HH:mm',
                                    keepOpen: false
                                });
                                $('#datetimepicker-work-end-time').datetimepicker({
                                    format: 'HH:mm',
                                    keepOpen: false
                                });
                                $('#datetimepicker-lunch-start-time').datetimepicker({
                                    format: 'HH:mm',
                                    keepOpen: false
                                });
                                $('#datetimepicker-lunch-end-time').datetimepicker({
                                    format: 'HH:mm',
                                    keepOpen: false
                                });
                            }
                        }
                        catch (err) {
                            console.error(err);
                        }
                    });
                }

                function saveCrew(crew) {
                    if (crew == '') crew = '0';
                    $.ajax({
                        type: 'POST',
                        url: $('#form-crew-edit').attr('action') + crew + '/',
                        data: $('#form-crew-edit').serialize()
                    })
                        .done(function(data){
                            if(data=='ok') {
                                $.fancybox.close();
                                $.notify('Сохранено', 'success');
                                loadCrew();
                                loadEventsList(100);
                            }
                            else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных', 'error');
                        });
                }

                function loadServiceList() {
                    $.getJSON( "{% url 'api_service_list' %}{{ crew.slug }}/", function( data ) {
                        try {
                            if (data['message'] == '') {
                                var tmpl = $.templates("#tmpl-crew-service-list");
                                var html = tmpl.render(data);
                                $('#crew-service-list').html(html);
                            }
                        }
                        catch (err) {
                            console.error(err);
                        }
                    });
                }

                function editService(service) {
                    if (service == '0') {
                        var tmpl = $.templates("#tmpl-crew-service-edit");
                        var html = tmpl.render({data: ''});
                        $('#hidden-crew-service-edit').html(html);
                        $.fancybox.open({
                            src: '#hidden-crew-service-edit',
                            type: 'inline',
                            opts: {modal: true}
                        });
                        $.validate({
                            form : '#form-crew-service-edit'
                        });
                    } else {
                        $.getJSON( "{% url 'api_service_edit' %}" + service + "/", function( data ) {
                            try {
                                if (data['message'] == '') {
                                    var tmpl = $.templates("#tmpl-crew-service-edit");
                                    var html = tmpl.render(data);
                                    $('#hidden-crew-service-edit').html(html);
                                    $.fancybox.open({
                                        src: '#hidden-crew-service-edit',
                                        type: 'inline',
                                        opts: {modal: true}
                                    });
                                    $.validate({
                                        form : '#form-crew-service-edit'
                                    });
                                } else {
                                    $.notify(data['message'], 'error');
                                }
                            }
                            catch (err) {
                                console.error(err);
                            }
                        });
                    }
                }

                function deleteService(service) {
                    $.ajax({
                        type: 'GET',
                        url: '{% url 'api_service_delete' %}' + service + '/'
                    })
                        .done(function(data){
                            if (data=='ok') {
                                $.notify('Сохранено', 'success');
                                loadServiceList();
                                loadEventsList(100);
                            } else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных');
                        });
                }

                function saveService(service) {
                    if (service == '') service = '0';
                    $.ajax({
                        type: 'POST',
                        url: $('#form-crew-service-edit').attr('action') + service + '/',
                        data: $('#form-crew-service-edit').serialize()
                    })
                        .done(function(data){
                            if(data=='ok') {
                                $.fancybox.close();
                                $.notify('Сохранено', 'success');
                                loadServiceList();
                                loadEventsList(100);
                            }
                            else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных', 'error');
                        });

                }

                function getPrice(service) {
                    $.getJSON( "{% url 'api_service_price_list' %}" + service + "/", function( data ) {
                        try {
                            if (data['message'] == '') {
                                var tmpl = $.templates("#tmpl-service-price-list");
                                var html = tmpl.render(data);
                                $('#hidden-service-price-list').html(html);
                                $.fancybox.open({
                                    src: '#hidden-service-price-list',
                                    type: 'inline',
                                    opts: {modal: true}
                                });
                            }
                        }
                        catch (err) {
                            console.error(err);
                        }
                    });
                }

                function editPrice(price) {
                    if (price == '0') {
                        var tmpl = $.templates("#tmpl-service-price-edit");
                        var html = tmpl.render({data: ''});
                        $('#hidden-service-price-edit').html(html);
                        $('#form-service-price-edit input[name="service"]').val($('#service-id').val());
                        $.fancybox.open({
                            src: '#hidden-service-price-edit',
                            type: 'inline',
                            opts: {modal: true}
                        });
                        $.validate({
                            form : '#form-service-price-edit'
                        });
                        $('#datetimepicker-start-date').datetimepicker({
                            format: 'YYYY-MM-DD',
                            keepOpen: false
                        });
                    } else {
                        $.getJSON( "{% url 'api_service_price_edit' %}" + price + "/", function( data ) {
                            try {
                                if (data['message'] == '') {
                                    var tmpl = $.templates("#tmpl-service-price-edit");
                                    var html = tmpl.render(data);
                                    $('#hidden-service-price-edit').html(html);
                                    $.fancybox.open({
                                        src: '#hidden-service-price-edit',
                                        type: 'inline',
                                        opts: {modal: true}
                                    });
                                    $.validate({
                                        form : '#form-service-price-edit'
                                    });
                                    $('#datetimepicker-start-date').datetimepicker({
                                        format: 'YYYY-MM-DD',
                                        keepOpen: false
                                    });
                                } else {
                                    $.notify(data['message'], 'error');
                                }
                            }
                            catch (err) {
                                console.error(err);
                            }
                        });
                    }
                }

                function savePrice(price) {
                    if (price == '') price = '0';
                    $.ajax({
                        type: 'POST',
                        url: $('#form-service-price-edit').attr('action') + price + '/',
                        data: $('#form-service-price-edit').serialize()
                    })
                        .done(function(data){
                            if(data=='ok') {
                                $.fancybox.close();
                                $.fancybox.close();
                                $.notify('Сохранено', 'success');
                                getPrice($('#form-service-price-edit input[name="service"]').val());
                                loadEventsList(100);
                            }
                            else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных', 'error');
                        });

                }

                function loadUserList() {
                    $.getJSON( "{% url 'api_user_list' %}{{ crew.slug }}/", function( data ) {
                        try {
                            if (data['message'] == '') {
                                var tmpl = $.templates("#tmpl-crew-user-list");
                                var html = tmpl.render(data);
                                $('#crew-user-list').html(html);
                            }
                        }
                        catch (err) {
                            console.error(err);
                        }
                    });
                }

                function saveUser(member, type) {
                    $.ajax({
                        type: 'GET',
                        url: '{% url 'api_user_edit' %}' + member + '/' + type + '/'
                    })
                        .done(function(data){
                            if(data=='ok') {
                                $.fancybox.close();
                                $.notify('Сохранено', 'success');
                                loadUserList();
                                loadEventsList(100);
                            }
                            else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных', 'error');
                        });

                }


                function deleteUser(member) {
                    $.ajax({
                        type: 'GET',
                        url: '{% url 'api_user_delete' %}' + member + '/'
                    })
                        .done(function(data){
                            if (data=='ok') {
                                $.notify('Сохранено', 'success');
                                loadUserList();
                                loadEventsList(100);
                            } else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных');
                        });
                }

                function openInvite() {
                    var tmpl = $.templates("#tmpl-crew-user-invite");
                    var html = tmpl.render('');
                    $('#hidden-crew-user-add').html(html);
                    $.fancybox.open({
                        src: '#hidden-crew-user-add',
                        type: 'inline',
                        opts: {modal: true}
                    });
                    $.validate({
                        form : '#form-crew-user-invite'
                    });
                }

                function saveInvite() {
                    $.ajax({
                        type: 'POST',
                        url: $('#form-crew-user-invite').attr('action'),
                        data: $('#form-crew-user-invite').serialize()
                    })
                        .done(function(data){
                            if(data=='ok') {
                                $.fancybox.close();
                                $.notify('Приглашение отправлено', 'success');
                                loadEventsList(100);
                            }
                            else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных', 'error');
                        });
                }

                function addExistUser() {
                    var tmpl = $.templates("#tmpl-crew-user-add");
                    var html = tmpl.render('');
                    $('#hidden-crew-user-add').html(html);
                    $.fancybox.open({
                        src: '#hidden-crew-user-add',
                        type: 'inline',
                        opts: {modal: true}
                    });
                    $.validate({
                        form : '#form-crew-user-add'
                    });
                }

                function loadPriorityList() {
                    $.getJSON( "{% url 'api_priority_list' %}{{ crew.slug }}/", function( data ) {
                        try {
                            if (data['message'] == '') {
                                var tmpl = $.templates("#tmpl-task-priority-list");
                                var html = tmpl.render(data);
                                $('#task-priority-list').html(html);
                            }
                        }
                        catch (err) {
                            console.error(err);
                        }
                    });
                }

                function editPriority(priority) {
                    if (priority == '0') {
                        var tmpl = $.templates("#tmpl-task-priority-edit");
                        var html = tmpl.render({data: ''});
                        $('#hidden-task-priority-edit').html(html);
                        $.fancybox.open({
                            src: '#hidden-task-priority-edit',
                            type: 'inline',
                            opts: {modal: true}
                        });
                        $.validate({
                            form : '#form-task-priority-edit'
                        });
                    } else {
                        $.getJSON( "{% url 'api_priority_edit' %}" + priority + "/", function( data ) {
                            try {
                                if (data['message'] == '') {
                                    var tmpl = $.templates("#tmpl-task-priority-edit");
                                    var html = tmpl.render(data);
                                    $('#hidden-task-priority-edit').html(html);
                                    $.fancybox.open({
                                        src: '#hidden-task-priority-edit',
                                        type: 'inline',
                                        opts: {modal: true}
                                    });
                                    $.validate({
                                        form : '#form-task-priority-edit'
                                    });
                                } else {
                                    $.notify(data['message'], 'error');
                                }
                            }
                            catch (err) {
                                console.error(err);
                            }
                        });
                    }
                }

                function deletePriority(priority) {
                    $.ajax({
                        type: 'GET',
                        url: '{% url 'api_priority_delete' %}' + priority + '/'
                    })
                        .done(function(data){
                            if (data=='ok') {
                                $.notify('Сохранено', 'success');
                                loadPriorityList();
                                loadEventsList(100);
                            } else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных');
                        });
                }

                function savePriority(priority) {
                    if (priority == '') priority = '0';
                    $.ajax({
                        type: 'POST',
                        url: $('#form-task-priority-edit').attr('action') + priority + '/',
                        data: $('#form-task-priority-edit').serialize()
                    })
                        .done(function(data){
                            if(data=='ok') {
                                $.fancybox.close();
                                $.notify('Сохранено', 'success');
                                loadPriorityList();
                                loadEventsList(100);
                            }
                            else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных', 'error');
                        });

                }

                function loadTableList() {
                    $.getJSON( "{% url 'api_table_list' %}{{ crew.slug }}/", function( data ) {
                        try {
                            if (data['message'] == '') {
                                var tmpl = $.templates("#tmpl-crew-table-list");
                                var html = tmpl.render(data);
                                $('#crew-table-list').html(html);
                            }
                        }
                        catch (err) {
                            console.error(err);
                        }
                    });
                }

                function editTable(table) {
                    if (table == '0') {
                        var tmpl = $.templates("#tmpl-crew-table-edit");
                        var html = tmpl.render({data: ''});
                        $('#hidden-crew-table-edit').html(html);
                        $.fancybox.open({
                            src: '#hidden-crew-table-edit',
                            type: 'inline',
                            opts: {modal: true}
                        });
                        $.validate({
                            form : '#form-crew-table-edit'
                        });
                    } else {
                        $.getJSON( "{% url 'api_table_edit' %}" + table + "/", function( data ) {
                            try {
                                if (data['message'] == '') {
                                    var tmpl = $.templates("#tmpl-crew-table-edit");
                                    var html = tmpl.render(data);
                                    $('#hidden-crew-table-edit').html(html);
                                    $.fancybox.open({
                                        src: '#hidden-crew-table-edit',
                                        type: 'inline',
                                        opts: {modal: true}
                                    });
                                    $.validate({
                                        form : '#form-crew-table-edit'
                                    });
                                } else {
                                    $.notify(data['message'], 'error');
                                }
                            }
                            catch (err) {
                                console.error(err);
                            }
                        });
                    }
                }

                function deleteTable(table) {
                    $.ajax({
                        type: 'GET',
                        url: '{% url 'api_table_delete' %}' + table + '/'
                    })
                        .done(function(data){
                            if (data=='ok') {
                                $.notify('Сохранено', 'success');
                                loadTableList();
                                loadEventsList(100);
                            } else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных');
                        });
                }

                function saveTable(table) {
                    if (table == '') table = '0';
                    $.ajax({
                        type: 'POST',
                        url: $('#form-crew-table-edit').attr('action') + table + '/',
                        data: $('#form-crew-table-edit').serialize()
                    })
                        .done(function(data){
                            if(data=='ok') {
                                $.fancybox.close();
                                $.notify('Сохранено', 'success');
                                loadTableList();
                                loadEventsList(100);
                            }
                            else {
                                $.notify(data, 'warn');
                            }
                        })
                        .fail(function(){
                            $.notify('Ошибка передачи данных', 'error');
                        });

                }

                function loadEventsList(limit) {
                    $.getJSON( "{% url 'api_event_list' crew.slug %}" + limit + "/", function( data ) {
                        try {
                            if (data['message'] == '') {
                                var tmpl = $.templates("#tmpl-crew-events-list");
                                var html = tmpl.render(data);
                                $('#crew-events-list').html(html);
                            }
                        }
                        catch (err) {
                            console.error(err);
                        }
                    });
                }

                function init() {
                    loadCrew();
                    loadServiceList();
                    loadUserList();
                    loadPriorityList();
                    loadTableList();
                    loadEventsList(100);
                }
            </script>
        {% endif %}
{% endblock %}
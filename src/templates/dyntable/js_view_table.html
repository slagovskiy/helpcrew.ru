<script>
    function loadTableView() {
        $.getJSON( "{% url 'api_table_list' %}{{ crew.slug }}/", function( data ) {
            try {
                if (data['message'] == '') {
                    var tmpl = $.templates("#tmpl-view-table-list");
                    var html = tmpl.render(data);
                    $('#view-table-list').html(html);
                }
            }
            catch (err) {
                console.error(err);
            }
        });
    }

    function loadTableRowsView(table) {
        $.getJSON( "{% url 'api_record_list' %}" + table + "/", function( data ) {
            try {
                if (data['message'] == '') {
                    var tmpl = $.templates("#tmpl-table-record-list");
                    var html = tmpl.render(data);
                    $('#table-record-list' + table).html(html);
                    $('.table').footable();
                }
            }
            catch (err) {
                console.error(err);
            }
        });
    }

    function openTableFormView(table, index) {
        $.getJSON( "{% url 'api_index_data' %}" + table + "/" + index + "/", function( data ) {
            try {
                if (data['message'] == '') {
                    var tmpl = $.templates("#tmpl-view-table-form");
                    var html = tmpl.render(data);
                    $('#hidden-view-table-form' + table).html(html);
                    $('#form-view-record' + table + ' input[name="index"]').val(index);
                    $.fancybox.open({
                        src: '#hidden-view-table-form' + table,
                        type: 'inline',
                        opts: {modal: true}
                    });
                    $.validate({
                        form : '#form-view-record' + table
                    });
                }
            }
            catch (err) {
                console.error(err);
            }
        });
    }

    function saveRecord(table) {
        if (table == '') table = '0';
        $.ajax({
            type: 'POST',
            url: $('#form-view-record' + table).attr('action') + table + '/',
            data: $('#form-view-record' + table).serialize()
        })
            .done(function(data){
                if(data=='ok') {
                    $.fancybox.close();
                    $.notify('Сохранено', 'success');
                    loadTableRowsView(table);
                    loadEventsList(table);
                }
                else {
                    $.notify(data, 'warn');
                }
            })
            .fail(function(){
                $.notify('Ошибка передачи данных', 'error');
            });
    }

    function importFromCSV(table) {
        nyi();
    }
</script>